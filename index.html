<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mind Map Maker</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
      background: #f5f5f5;
    }
    svg {
      width: 100vw;
      height: 100vh;
      touch-action: none;
    }
    .node {
      fill: white;
      stroke: black;
      stroke-width: 2px;
      cursor: pointer;
    }
    .link {
      stroke: #999;
      stroke-width: 2px;
    }
    .label {
      font-size: 14px;
      text-anchor: middle;
      pointer-events: none;
    }
    .fab {
      position: fixed;
      bottom: 20px;
      padding: 12px 16px;
      margin: 5px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 20px;
      font-size: 16px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      z-index: 100;
      width: 120px;
      text-align: center;
    }
    .menu {
  position: fixed;
  bottom: 20px;
  left: 20px;
  max-height: 90%;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
  z-index: 100;
  padding-right: 5px; /* space for hidden scrollbar */
  scrollbar-width: none; /* Firefox */
}
.menu::-webkit-scrollbar {
  display: none; /* Chrome/Safari */
}
    }
    .fab.green { background: #28a745; }
    .fab.gray  { background: #6c757d; }
    input[type="file"] {
      display: none;
    }
  </style>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="menu">
    <button class="fab" onclick="saveMap()">üíæ Save</button>
    <label class="fab green" style="cursor:pointer">
      üìÇ Load<input type="file" onchange="loadMap(event)">
    </label>
    <button class="fab" onclick="exportImage()">üñºÔ∏è PNG</button>
    <button class="fab" onclick="exportPDF()">üìÑ PDF</button>
    <button class="fab gray" onclick="undo()">‚Ü©Ô∏è Undo</button>
    <button class="fab gray" onclick="redo()">‚Ü™Ô∏è Redo</button>
  </div>
  <svg id="mindmap"></svg>

  <script>
    const svg = d3.select("#mindmap");
    const g = svg.append("g");
    const width = window.innerWidth;
    const height = window.innerHeight;

    // Enable zoom & pan
    svg.call(
      d3.zoom()
        .scaleExtent([0.2, 3])
        .on("zoom", (event) => {
          g.attr("transform", event.transform);
        })
    ).on("dblclick.zoom", null);

    let nodes = [{ id: 1, label: "Root", x: width / 2, y: height / 2 }];
    let links = [];
    let selectedId = 1;
    let history = [];
    let future = [];

    function saveState() {
      history.push(JSON.stringify({ nodes, links, selectedId }));
      if (history.length > 50) history.shift();
      future = [];
    }

    function restore(state) {
      const data = JSON.parse(state);
      nodes = data.nodes;
      links = data.links;
      selectedId = data.selectedId;
      update();
    }

    function undo() {
      if (history.length < 2) return;
      future.push(history.pop());
      restore(history[history.length - 1]);
    }

    function redo() {
      if (future.length === 0) return;
      const state = future.pop();
      history.push(state);
      restore(state);
    }

    function getNodeById(id) {
      return nodes.find(n => n.id === id);
    }

    function update() {
      g.selectAll("*").remove();

      g.selectAll("line")
        .data(links)
        .join("line")
        .attr("class", "link")
        .attr("x1", d => getNodeById(d.source).x)
        .attr("y1", d => getNodeById(d.source).y)
        .attr("x2", d => getNodeById(d.target).x)
        .attr("y2", d => getNodeById(d.target).y);

      const nodeGroup = g.selectAll("g")
        .data(nodes, d => d.id)
        .join("g")
        .attr("transform", d => `translate(${d.x},${d.y})`)
        .on("click", (event, d) => {
          event.stopPropagation();
          selectedId = d.id;
        })
        .call(d3.drag().on("drag", (event, d) => {
          d.x = event.x;
          d.y = event.y;
          update();
        }));

      nodeGroup.append("circle")
        .attr("r", 30)
        .attr("class", "node")
        .attr("stroke", d => d.id === selectedId ? "blue" : "black")
        .attr("stroke-width", d => d.id === selectedId ? 4 : 2);

      nodeGroup.append("text")
        .attr("class", "label")
        .attr("dy", "0.35em")
        .text(d => d.label)
        .style("pointer-events", "all")
        .on("click", (event, d) => {
          event.stopPropagation();
          const newLabel = prompt("Edit label:", d.label);
          if (newLabel) {
            d.label = newLabel;
            saveState();
            update();
          }
        });

      // Add (+) button
      nodeGroup.append("text")
        .attr("x", 35)
        .attr("y", -10)
        .attr("class", "label")
        .style("font-size", "16px")
        .style("cursor", "pointer")
        .style("pointer-events", "all")
        .text("+")
        .on("click", (event, d) => {
          event.stopPropagation();
          addNodeTo(d.id);
        });

      // Add (üóëÔ∏è) button
      nodeGroup.append("text")
        .attr("x", 35)
        .attr("y", 10)
        .attr("class", "label")
        .style("font-size", "16px")
        .style("cursor", "pointer")
        .style("pointer-events", "all")
        .text("üóëÔ∏è")
        .on("click", (event, d) => {
          event.stopPropagation();
          if (d.id === 1) return alert("Can't delete root");
          deleteNodeById(d.id);
        });
    }

    function addNodeTo(parentId) {
      const id = Date.now();
      const label = prompt("Label:", "Node") || "Node";
      const parent = getNodeById(parentId);
      const children = links.filter(l => l.source === parentId).length;
      const angle = (children * 45) * (Math.PI / 180);
      const x = parent.x + 120 * Math.cos(angle);
      const y = parent.y + 120 * Math.sin(angle);

      nodes.push({ id, label, x, y });
      links.push({ source: parentId, target: id });
      selectedId = id;
      saveState();
      update();
    }

    function deleteNodeById(id) {
      nodes = nodes.filter(n => n.id !== id);
      links = links.filter(l => l.source !== id && l.target !== id);
      if (selectedId === id) selectedId = 1;
      saveState();
      update();
    }

    function saveMap() {
      const data = { nodes, links };
      const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "mindmap.json";
      a.click();
    }

    function loadMap(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        const data = JSON.parse(e.target.result);
        nodes = data.nodes;
        links = data.links;
        selectedId = 1;
        saveState();
        update();
      };
      reader.readAsText(file);
    }

    function exportImage() {
      const clone = svg.node().cloneNode(true);
      const svgData = new XMLSerializer().serializeToString(clone);
      const svgBlob = new Blob([svgData], { type: "image/svg+xml;charset=utf-8" });
      const url = URL.createObjectURL(svgBlob);

      const img = new Image();
      img.onload = function () {
        const canvas = document.createElement("canvas");
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext("2d");
        ctx.fillStyle = "#f5f5f5";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);
        canvas.toBlob(blob => {
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = "mindmap.png";
          a.click();
        });
      };
      img.src = url;
    }

    async function exportPDF() {
      const clone = svg.node().cloneNode(true);
      const svgData = new XMLSerializer().serializeToString(clone);
      const svgBlob = new Blob([svgData], { type: "image/svg+xml;charset=utf-8" });
      const url = URL.createObjectURL(svgBlob);

      const img = new Image();
      img.onload = async function () {
        const canvas = document.createElement("canvas");
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext("2d");
        ctx.fillStyle = "#f5f5f5";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);

        const imgData = canvas.toDataURL("image/png");
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
          orientation: "landscape",
          unit: "px",
          format: [canvas.width, canvas.height]
        });

        pdf.addImage(imgData, "PNG", 0, 0, canvas.width, canvas.height);
        pdf.save("mindmap.pdf");
      };
      img.src = url;
    }

    // Init
    saveState();
    update();
  </script>
</body>
</html>
