<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mind Map Maker</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
      background: #f5f5f5;
    }
    svg {
      width: 100vw;
      height: 100vh;
      touch-action: none;
    }
    .node {
      fill: white;
      stroke: black;
      stroke-width: 2px;
      cursor: pointer;
    }
    .link {
      stroke: #999;
      stroke-width: 2px;
    }
    .label {
      font-size: 14px;
      text-anchor: middle;
      pointer-events: none;
    }
    .fab {
      padding: 10px 12px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 20px;
      font-size: 14px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      white-space: nowrap;
      flex-shrink: 0;
    }
    .fab.green { background: #28a745; }
    .fab.gray  { background: #6c757d; }

    .menu {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      overflow-x: auto;
      display: flex;
      flex-direction: row;
      gap: 10px;
      z-index: 100;
      padding: 10px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 12px;
      scrollbar-width: none;
    }
    .menu::-webkit-scrollbar {
      display: none;
    }
    .menu.hidden {
      display: none;
    }

    #toggleMenu {
      position: fixed;
      right: 20px;
      bottom: 90px;
      z-index: 101;
      padding: 12px 16px;
      border-radius: 20px;
      background: #343a40;
      color: white;
      border: none;
      font-size: 18px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }

    #noteModal {
      display: none;
      position: fixed;
      top: 20%;
      left: 10%;
      right: 10%;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
      z-index: 1000;
    }
    #noteModal textarea {
      width: 100%;
      height: 150px;
    }
  </style>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<button id="toggleMenu">‚ò∞</button>
<div class="menu">
  <button class="fab" onclick="saveMap()">üíæ Save</button>
  <label class="fab green" style="cursor:pointer">
    üìÇ Load<input type="file" onchange="loadMap(event)">
  </label>
  <button class="fab" onclick="exportImage()">üñºÔ∏è PNG</button>
  <button class="fab" onclick="exportPDF()">üìÑ PDF</button>
  <button class="fab gray" onclick="undo()">‚Ü©Ô∏è Undo</button>
  <button class="fab gray" onclick="redo()">‚Ü™Ô∏è Redo</button>
</div>

<svg id="mindmap"></svg>

<div id="noteModal">
  <h3>Edit Note</h3>
  <textarea id="noteInput"></textarea><br/>
  <button onclick="saveNote()">Save</button>
  <button onclick="closeNote()">Cancel</button>
</div>

<script>
const svg = d3.select("#mindmap");
const g = svg.append("g");
const width = window.innerWidth;
const height = window.innerHeight;

svg.call(
  d3.zoom().scaleExtent([0.2, 3]).on("zoom", (event) => g.attr("transform", event.transform))
).on("dblclick.zoom", null);

let nodes = [{ id: 1, label: "Root", x: width / 2, y: height / 2 }];
let links = [];
let selectedId = 1;
let history = [];
let future = [];
let editingNodeId = null;

function saveState() {
  history.push(JSON.stringify({ nodes, links, selectedId }));
  if (history.length > 50) history.shift();
  future = [];
}

function restore(state) {
  const data = JSON.parse(state);
  nodes = data.nodes;
  links = data.links;
  selectedId = data.selectedId;
  update();
}

function undo() {
  if (history.length < 2) return;
  future.push(history.pop());
  restore(history[history.length - 1]);
}

function redo() {
  if (future.length === 0) return;
  const state = future.pop();
  history.push(state);
  restore(state);
}

function getNodeById(id) {
  return nodes.find(n => n.id === id);
}

function autoSpace(x, y, w, h) {
  let tries = 0;
  while (tries++ < 10) {
    const collision = nodes.some(n =>
      Math.abs(x - n.x) < w && Math.abs(y - n.y) < h
    );
    if (!collision) break;
    x += 20;
    y += 20;
  }
  return { x, y };
}

function update() {
  g.selectAll("*").remove();

  g.selectAll("line")
    .data(links)
    .join("line")
    .attr("class", "link")
    .attr("x1", d => getNodeById(d.source).x)
    .attr("y1", d => getNodeById(d.source).y)
    .attr("x2", d => getNodeById(d.target).x)
    .attr("y2", d => getNodeById(d.target).y);

  const nodeGroup = g.selectAll("g")
    .data(nodes, d => d.id)
    .join("g")
    .attr("transform", d => `translate(${d.x},${d.y})`)
    .on("click", (event, d) => {
      event.stopPropagation();
      selectedId = d.id;
    })
    .call(d3.drag().on("drag", (event, d) => {
      d.x = event.x;
      d.y = event.y;
      update();
    }));

  nodeGroup.append("circle")
    .attr("r", 30)
    .attr("class", "node")
    .attr("stroke", d => d.id === selectedId ? "blue" : "black")
    .attr("stroke-width", d => d.id === selectedId ? 4 : 2);

  nodeGroup.append("text")
    .attr("class", "label")
    .attr("dy", "0.35em")
    .text(d => d.label)
    .style("pointer-events", "all")
    .on("click", (event, d) => {
      event.stopPropagation();
      const newLabel = prompt("Edit label:", d.label);
      if (newLabel) {
        d.label = newLabel;
        saveState();
        update();
      }
    });

  nodeGroup.append("text")
    .attr("x", 35)
    .attr("y", -10)
    .attr("class", "label")
    .style("font-size", "16px")
    .style("cursor", "pointer")
    .style("pointer-events", "all")
    .text("+")
    .on("click", (event, d) => {
      event.stopPropagation();
      addNodeTo(d.id);
    });

  nodeGroup.append("text")
    .attr("x", 35)
    .attr("y", 10)
    .attr("class", "label")
    .style("font-size", "16px")
    .style("cursor", "pointer")
    .style("pointer-events", "all")
    .text("üóëÔ∏è")
    .on("click", (event, d) => {
      event.stopPropagation();
      if (d.id === 1) return alert("Can't delete root");
      deleteNodeById(d.id);
    });

  nodeGroup.append("text")
    .attr("x", -45)
    .attr("y", -40)
    .attr("class", "label")
    .style("font-size", "14px")
    .style("cursor", "pointer")
    .style("pointer-events", "all")
    .text("üìÑ")
    .on("click", (event, d) => {
      event.stopPropagation();
      openNoteEditor(d);
    });

  // Draw notes
  nodes.forEach(d => {
    if (!d.note) return;
    const lines = d.note.split(/\n|\r|\r\n/);
    const noteWidth = 160;
    const lineHeight = 16;
    const noteHeight = lines.length * lineHeight + 10;
    const { x: nx, y: ny } = autoSpace(d.x + 40, d.y - noteHeight / 2, noteWidth + 30, noteHeight + 20);

    g.append("rect")
      .attr("x", nx)
      .attr("y", ny)
      .attr("width", noteWidth)
      .attr("height", noteHeight)
      .attr("rx", 10)
      .attr("ry", 10)
      .attr("fill", "#fff8dc")
      .attr("stroke", "#aaa");

    lines.forEach((line, i) => {
      g.append("text")
        .attr("x", nx + noteWidth / 2)
        .attr("y", ny + 20 + i * lineHeight)
        .attr("class", "label")
        .text(line);
    });
  });
}

function addNodeTo(parentId) {
  const id = Date.now();
  const label = prompt("Label:", "Node") || "Node";
  const parent = getNodeById(parentId);
  const children = links.filter(l => l.source === parentId).length;
  const angle = (children * 45) * (Math.PI / 180);
  let x = parent.x + 120 * Math.cos(angle);
  let y = parent.y + 120 * Math.sin(angle);
  const spaced = autoSpace(x, y, 60, 60);
  x = spaced.x; y = spaced.y;

  nodes.push({ id, label, x, y });
  links.push({ source: parentId, target: id });
  selectedId = id;
  saveState();
  update();
}

function deleteNodeById(id) {
  nodes = nodes.filter(n => n.id !== id);
  links = links.filter(l => l.source !== id && l.target !== id);
  if (selectedId === id) selectedId = 1;
  saveState();
  update();
}

function openNoteEditor(node) {
  document.getElementById("noteInput").value = node.note || "";
  editingNodeId = node.id;
  document.getElementById("noteModal").style.display = "block";
}

function closeNote() {
  document.getElementById("noteModal").style.display = "none";
}

function saveNote() {
  const text = document.getElementById("noteInput").value;
  const node = getNodeById(editingNodeId);
  node.note = text;
  closeNote();
  saveState();
  update();
}

function saveMap() {
  const data = { nodes, links };
  const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "mindmap.json";
  a.click();
}

function loadMap(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const data = JSON.parse(e.target.result);
    nodes = data.nodes;
    links = data.links;
    selectedId = 1;
    saveState();
    update();
  };
  reader.readAsText(file);
}

function exportImage() {
  const clone = svg.node().cloneNode(true);
  inlineStyles(clone);
  const svgData = new XMLSerializer().serializeToString(clone);
  const svgBlob = new Blob([svgData], { type: "image/svg+xml;charset=utf-8" });
  const url = URL.createObjectURL(svgBlob);

  const img = new Image();
  img.onload = function () {
    const canvas = document.createElement("canvas");
    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext("2d");
    ctx.fillStyle = "#f5f5f5";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0);
    canvas.toBlob(blob => {
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "mindmap.png";
      a.click();
    });
  };
  img.src = url;
}

function exportPDF() {
  const clone = svg.node().cloneNode(true);
  inlineStyles(clone);
  const svgData = new XMLSerializer().serializeToString(clone);
  const svgBlob = new Blob([svgData], { type: "image/svg+xml;charset=utf-8" });
  const url = URL.createObjectURL(svgBlob);

  const img = new Image();
  img.onload = function () {
    const canvas = document.createElement("canvas");
    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext("2d");
    ctx.fillStyle = "#f5f5f5";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0);

    const imgData = canvas.toDataURL("image/png");
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ orientation: "landscape", unit: "px", format: [canvas.width, canvas.height] });
    pdf.addImage(imgData, "PNG", 0, 0, canvas.width, canvas.height);
    pdf.save("mindmap.pdf");
  };
  img.src = url;
}

function inlineStyles(svgElement) {
  svgElement.querySelectorAll("*").forEach(el => {
    const computed = getComputedStyle(el);
    el.setAttribute("fill", computed.fill);
    el.setAttribute("stroke", computed.stroke);
    el.setAttribute("stroke-width", computed["stroke-width"]);
    el.setAttribute("font-size", computed["font-size"]);
    el.setAttribute("font-family", computed["font-family"]);
    el.setAttribute("text-anchor", computed["text-anchor"]);
    el.setAttribute("dominant-baseline", computed["dominant-baseline"]);
  });
}

// Init
saveState();
update();

document.getElementById("toggleMenu").addEventListener("click", () => {
  document.querySelector(".menu").classList.toggle("hidden");
});
</script>
</body>
</html>
